# Notification System

This guide explains how to configure and use Verifily's notification system for alerting teams about gate results.

## Overview

The notification system sends alerts when Verifily gates complete, enabling teams to:

- React quickly to quality failures
- Monitor production data quality
- Integrate with existing workflows (Slack, GitHub, webhooks)

## Security First

**Verifily's notification system never leaks:**
- Raw dataset content
- User text/inputs/outputs
- Secrets or credentials
- Full file paths

## Supported Channels

| Channel | Use Case | Setup Complexity |
|---------|----------|------------------|
| **Webhook** | Generic integration | Easy |
| **Slack** | Team alerts | Easy |
| **GitHub PR** | CI/CD integration | Medium |

## Configuration

### Environment Variables

```bash
# Enable notifications
export VERIFILY_NOTIFY=1

# Webhook endpoint
export VERIFILY_NOTIFY_WEBHOOK_URL="https://hooks.example.com/verifily"

# Slack webhook
export VERIFILY_NOTIFY_SLACK_WEBHOOK_URL="https://hooks.slack.com/services/..."

# GitHub integration
export VERIFILY_GITHUB_TOKEN="ghp_xxxxxxxx"
export VERIFILY_GITHUB_REPO="myorg/myrepo"
export VERIFILY_GITHUB_PR="123"

# When to notify (default: DONT_SHIP,INVESTIGATE)
export VERIFILY_NOTIFY_ONLY_ON="DONT_SHIP,INVESTIGATE,SHIP"

# Also notify on SHIP (default: false)
export VERIFILY_NOTIFY_INCLUDE_SHIP=0
```

### Programmatic Configuration

```python
from verifily_cli_v1.core.api.notifier import (
    NotificationConfig,
    NotificationTarget,
    NotificationTargetType,
)

config = NotificationConfig(
    enabled=True,
    targets=[
        NotificationTarget(
            type=NotificationTargetType.SLACK,
            url="https://hooks.slack.com/services/...",
        ),
    ],
    only_on=["DONT_SHIP", "INVESTIGATE"],
    include_on_ship=False,
    timeout_s=5.0,
    max_retries=3,
)
```

## Notification Events

Notifications trigger on:

| Event | Description |
|-------|-------------|
| `pipeline_done` | Sync pipeline completed |
| `job_done` | Async job completed |
| `monitor_alert` | Monitor detected issue |
| `retrain_done` | Retraining completed |

## Payload Format

### Webhook Payload

```json
{
  "event": "pipeline_done",
  "timestamp": "2025-01-20T12:00:00Z",
  "request_id": "req-abc123",
  "project_id": "proj-demo",
  "decision": "DONT_SHIP",
  "exit_code": 1,
  "run_id": "run_20250120_120000",
  "elapsed_ms": 1250,
  "metrics_summary": {
    "total_rows": 10000,
    "valid_rows": 9995
  },
  "contamination_summary": {
    "status": "FAIL",
    "jaccard_similarity": 0.35,
    "overlap_count": 150
  },
  "contracts_summary": {
    "total": 5,
    "passed": 3,
    "failed": 1,
    "warnings": 1
  },
  "artifacts": {
    "decision": "runs/run_20250120_120000/decision.json"
  }
}
```

**Important:** No raw text, inputs, or outputs included.

### Slack Message

```
❌ Verifily Gate: DONT_SHIP
Request ID: req-abc123
Contamination: FAIL
Contracts: 3/5 passed
Elapsed: 1250ms
```

### GitHub PR Comment

```markdown
## Verifily Gate Result: ❌ DONT_SHIP

**Request ID:** `req-abc123`

### Contamination Check
- Status: FAIL
- Jaccard Similarity: 35.00%

### Contracts
- Total: 5
- Passed: 3
- Failed: 1
- Warnings: 1

### Artifacts
- decision: `runs/run_20250120_120000/decision.json`

---
*This comment was generated by Verifily.*
```

## When to Notify

### Default Behavior

| Decision | Default | With `INCLUDE_SHIP=1` |
|----------|---------|----------------------|
| SHIP | ❌ No | ✅ Yes |
| INVESTIGATE | ✅ Yes | ✅ Yes |
| DONT_SHIP | ✅ Yes | ✅ Yes |

### Custom Triggers

```bash
# Only notify on failures
export VERIFILY_NOTIFY_ONLY_ON="DONT_SHIP"

# Notify on everything
export VERIFILY_NOTIFY_ONLY_ON="SHIP,INVESTIGATE,DONT_SHIP"
```

## Idempotency

Job notifications are sent **exactly once**:

```python
# First call - sends notification
result = client.get_job_result("job-123")  # Notification sent

# Second call - no notification
result = client.get_job_result("job-123")  # No notification (already sent)
```

This prevents duplicate alerts when polling for results.

## Testing

### Test Webhook

```bash
# Start a local webhook receiver
python3 -m http.server 9999 &

# Configure and test
export VERIFILY_NOTIFY=1
export VERIFILY_NOTIFY_WEBHOOK_URL="http://localhost:9999/webhook"

verifily pipeline --config verifily.yaml
```

### Test via CLI

```bash
verifily notify-test
```

This sends a test notification with:
- Decision: INVESTIGATE
- Exit code: 2
- Test data (no real run)

### Programmatic Test

```python
from verifily_cli_v1.core.api.notifier import (
    NotificationConfig,
    build_notification_payload,
    send_notifications,
)

config = NotificationConfig.from_env()

payload = build_notification_payload(
    request_id="test-123",
    project_id="test-project",
    decision="INVESTIGATE",
    exit_code=2,
)

result = send_notifications(config, payload)

if result.success:
    print(f"✅ Notification sent to {result.targets_ok} targets")
else:
    print(f"❌ Failed: {result.errors}")
```

## CI/CD Integration

### GitHub Actions with PR Comments

```yaml
- name: Run Verifily Gate
  env:
    VERIFILY_NOTIFY: 1
    VERIFILY_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    VERIFILY_GITHUB_REPO: ${{ github.repository }}
    VERIFILY_GITHUB_PR: ${{ github.event.pull_request.number }}
  run: verifily pipeline --config verifily.yaml
```

### GitLab CI with Slack

```yaml
verifily-gate:
  variables:
    VERIFILY_NOTIFY: "1"
    VERIFILY_NOTIFY_SLACK_WEBHOOK_URL: $SLACK_WEBHOOK_URL
  script:
    - verifily pipeline --config verifily.yaml
```

### Slack Integration

1. Create a Slack app at https://api.slack.com/apps
2. Enable "Incoming Webhooks"
3. Copy the webhook URL
4. Set environment variable:
   ```bash
   export VERIFILY_NOTIFY_SLACK_WEBHOOK_URL="https://hooks.slack.com/services/..."
   ```

## Retry Logic

Notifications use exponential backoff:

| Attempt | Delay |
|---------|-------|
| 1 | 0ms (immediate) |
| 2 | 200ms |
| 3 | 400ms |

Configure with:
```bash
export VERIFILY_NOTIFY_MAX_RETRIES=3
export VERIFILY_NOTIFY_BACKOFF_MS=200
```

## Error Handling

### Failures Don't Block Pipeline

```python
# Pipeline completes even if notification fails
result = pipeline.run(config)  # Always returns
# Notification sent best-effort
```

### Secrets Redacted

```
# Error message shows:
Connection failed to [REDACTED_URL]

# NOT:
Connection failed to https://hooks.slack.com/services/SECRET/TOKEN
```

## Best Practices

### 1. Use Separate Webhooks per Environment

```bash
# Production
export VERIFILY_NOTIFY_WEBHOOK_URL="https://alerts.prod.company.com/verifily"

# Staging
export VERIFILY_NOTIFY_WEBHOOK_URL="https://alerts.staging.company.com/verifily"
```

### 2. Filter in Webhook Receiver

```python
# Your webhook endpoint
def handle_webhook(payload):
    if payload["decision"] == "DONT_SHIP":
        pager_duty.trigger_incident(payload)
    elif payload["decision"] == "WARN":
        slack.send_to_channel("#data-quality", payload)
```

### 3. Include Context in Project ID

```bash
export VERIFILY_PROJECT_ID="team-ml/production-model-v2"
# Makes it clear which project/model failed
```

### 4. Monitor Notification Health

```python
# Track notification success rate
metrics.gauge("verifily.notifications.sent", result.targets_ok)
metrics.gauge("verifily.notifications.failed", result.targets_failed)
```

## Troubleshooting

### "No notifications received"

**Check:**
1. `VERIFILY_NOTIFY=1` is set
2. Target URLs are valid
3. Decision matches `ONLY_ON` list

### "Duplicate notifications"

**Cause:** Multiple pipeline runs with same request ID.

**Solution:** This is expected - each run gets its own notification.

### "GitHub comment not posted"

**Check:**
1. `VERIFILY_GITHUB_TOKEN` has `repo` scope
2. Token not expired
3. PR number is correct
4. Repo format is `owner/repo`

## Demo

Run the notification demo:

```bash
./scripts/demo_notify.sh
```

Expected output:
```
=== Verifily Notification Demo ===
...
✅ Payload redaction verified (no raw data)
✅ DONT_SHIP notified (expected)
✅ SHIP did not notify (expected)
=== Notification Demo -- ALL PASSED ===
```

## See Also

- [CI/CD Integration](./ci_integration.md)
- [Decision Gate](./decision_gate.md)
- [Monitor](./monitor.md)
