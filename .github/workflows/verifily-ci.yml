name: Verifily Data Quality Gate

on:
  push:
    paths: ['data/**', 'configs/**', 'verifily.yaml']
  pull_request:
    paths: ['data/**', 'configs/**', 'verifily.yaml']

jobs:
  quality-gate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Verifily
        run: pip install git+https://github.com/arsenis-cmd/verifily.git#egg=verifily[all]

      - name: Run Quality Gate
        id: verifily
        run: |
          set +e
          OUTPUT=$(verifily pipeline --config verifily.yaml --ci 2>&1)
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

          if echo "$OUTPUT" | grep -q "SHIP"; then
            echo "decision=SHIP" >> $GITHUB_OUTPUT
          elif echo "$OUTPUT" | grep -q "DONT_SHIP"; then
            echo "decision=DONT_SHIP" >> $GITHUB_OUTPUT
          elif echo "$OUTPUT" | grep -q "INVESTIGATE"; then
            echo "decision=INVESTIGATE" >> $GITHUB_OUTPUT
          else
            echo "decision=UNKNOWN" >> $GITHUB_OUTPUT
          fi

          echo "$OUTPUT"
          exit $EXIT_CODE

      - name: Post Results to PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const decision = '${{ steps.verifily.outputs.decision }}';
            const exitCode = '${{ steps.verifily.outputs.exit_code }}';
            const emoji = decision === 'SHIP' ? '✅' : decision === 'DONT_SHIP' ? '❌' : '⚠️';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ${emoji} Verifily Quality Gate: ${decision}\n\nExit code: ${exitCode}\n\n| Code | Meaning |\n|------|--------|\n| 0 | SHIP |\n| 1 | DONT_SHIP |\n| 2 | INVESTIGATE |\n| 3 | CONTRACT_FAIL |\n| 4 | TOOL_ERROR |`
            });
